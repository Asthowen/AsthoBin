name: Generate executables and post them to release

on:
  release:
    types: [published]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  generate-linux-executables:
    name: Build & publish for ${{ matrix.name }}
    runs-on: ubuntu-20.04
    strategy:
      matrix:
        name:
          - x86_64-pc-windows-msvc
          - i686-pc-windows-msvc
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Install toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable
          targets: ${{ matrix.name }}

      - name: Get AsthoBin version
        id: asthobin_version
        run: |
          echo "APP_VERSION=$(awk -F ' = ' '$1 ~ /version/ { gsub(/["]/, "", $2); printf("%s",$2) }' Cargo.toml)" >> $GITHUB_OUTPUT
          sudo apt install -y build-essential default-libmysqlclient-dev curl
          curl -fsSL https://deb.nodesource.com/setup_current.x | sudo bash - && sudo apt install -y nodejs && sudo npm install -g pnpm

      - name: Use GitHub cache
        uses: actions/cache@v2
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: Build
        run: cargo build --release --locked --target ${{ matrix.name }}

      - name: Upload executable to releases
        uses: Asthowen/UploadReleaseAsset@main
        env:
          GITHUB_TOKEN: ${{ github.token }}
        with:
          release_tag: ${{ steps.asthobin_version.outputs.APP_VERSION }}
          asset_path: ./target/${{ matrix.name }}/release/asthobin
          asset_name: asthobin-${{ steps.asthobin_version.outputs.APP_VERSION }}-${{ matrix.name }}
          asset_content_type: application/octet-stream